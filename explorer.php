<?php session_start();define('OLD_CONFIG', __DIR__.'/.config');define('NEW_CONFIG', __DIR__.'/.htconfig');if( @$_POST['upgrade'] == 'now' ){sleep(2);if( file_exists(NEW_CONFIG) ){output(true, 'You\'r already with a new update.');}else if( file_exists(OLD_CONFIG) ){$echo = array();$gitJSON = @json_decode(getData('https://raw.githubusercontent.com/webcdn/File-Explorer/standalone/repo.json'), true);if( !empty($gitJSON) ){if( !empty($gitJSON['latest_ver']) && !empty($gitJSON['latest_url']) ) {$getUpdatedData = getData($gitJSON['latest_url']);if( strlen($getUpdatedData) > 100 * 1024 ){$pass = json_decode( getData(OLD_CONFIG) )->password;if( strlen($pass) == 32 ){$data = json_encode(array('go_up' => false, 'show_hidden' => false, 'password' => $pass), JSON_PRETTY_PRINT);$echo[] = logout() ? 'Session Destroyed'  : wrapIt(0, 'removing previous instances');$echo[] = setData(NEW_CONFIG, $data) ? 'New Config Builded' : wrapIt(0, 'configuring new settings');$echo[] = unlink(OLD_CONFIG) ? 'Old Config Removed' : wrapIt(0, 'removing previous settings');}$echo[] = setData(basename(__FILE__), $getUpdatedData) ? wrapIt(1, 'Package Upgraded Successfully') : wrapIt(0, 'upgrading new package, Write us here - https://github.com/webcdn/File-Explorer/issues');output(true, $echo);}else {output(false, 'Invalid update URL');}}else {output(false, 'Invalid Parameters');}}else {output(false, 'Unable to fetch update info');}}else {output(false, 'No Default Configuration file exists, upgrade manually');}}function wrapIt($flag, $msg){$flag = !!$flag;$wrp = '<p style="color: %s; font-weight: bold;">%s</p>';$clr = $flag ? '#0F0' : '#F00';$msg = $flag ? $msg : "Error: {$msg}";return sprintf($wrp, $clr, $msg);}function output($flag, $response) {header('Content-Type: application/json');if( !is_array($response) ){$response = array( wrapIt($flag, $response) );}$data = array('flag' => (bool) $flag, 'response' => $response);exit(json_encode($data, JSON_PRETTY_PRINT));}function logout(){return session_destroy() && setcookie('__xsrf', '', time() - 3600);}function getData($uri){$is_URL = !!preg_match('/(https?:\/\/)/i', $uri);if( function_exists('curl_init') && ($is_URL || is_bool($uri)) ){if( is_bool($uri) ){return true;}$ch = curl_init();curl_setopt($ch, CURLOPT_URL, $uri);curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);curl_setopt($ch, CURLOPT_FOLLOWLOCATION, true);curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, false);curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, false);$output = curl_exec($ch);curl_close($ch);return $output;}elseif( function_exists('file_get_contents') && (!$is_URL || ini_get('allow_url_fopen')) ){if( is_bool($uri) ){return true;}return file_get_contents($uri);}return false;}function setData($uri, $data){if( function_exists('file_put_contents') ){return file_put_contents($uri, $data);}elseif( $fh = fopen($uri, 'wb') ){fwrite($fh, $data);fclose($fh);return true;}return false;}?><!DOCTYPE html><html lang="en"><head><title>Upgrade Console</title><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"><link rel="icon" type="image/png" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEgAAABICAMAAABiM0N1AAAAwFBMVEVMaXEhZZlLoeZUrO0obqRUrO0hZZkob69UrO5UrO4iZpkhZZlTq+1Vf6wiZJohZphUrO5UrO4hZZkhZZlUrO4hZZkiZJpVrO0hZplFldNUq+48icRFltRUrO1UrO5Uq+0hZZlVq+4eZJohZphUrO5Mn94iZplVrO4hZZlJm9tXruwiZphDlNFWrO1UrO1Vq+1VrO5Uq+0veK8mbKFOouM2gbpRp+hTqus6h8IzfbZEldNAkc0jaJwsc6lHmtgiZpkio2ylAAAAMHRSTlMA/A039JHTB96uLZYdAyiRcviI29XoTc2+zepM0VaewKZfIZh89l/z8+wp9O9HgmUP4OQcAAABgElEQVR4Ae3UBXbdQBBE0RYzmNkOg7HF5tn/qsLtz6IKJ3cBb0ZSHdF/fyo/sc/UNG3Lfrkd0UBOoKllNrYHdnbVKsGgSwVqtWdD3o+mWqxTb4lq9Yb6slWrM596eqfabb2gflSXjRgNibN138FC7Xk78dGQ0AIHDYldBw2J5HuFNB8NieR7hezvFTobGSqq27LmGfsnqT40VNw1vIxrDAvlNa+wZgwJ3WS8kusQ2BHPe4fyhtt4fUMPNbfaJLAjXAK/l9jpESryWxb93tH9p9lmPI41FcpLHi+dhKqMAUc0tTeEIaGiZkgooWuGrEUSKhni0rfQPWNOJPTAmGMJ3TDmUkLXjLmS0B1jLiT0yJhTCZWM0SXUMGSfvoUKxuxIKGeMJ6GKMZaE0BmlEkJndCQhdEaGhNAZhd9C9xn8WyP6HjNy6RMT/GgyIzp/KKqGMa/ok0OGZSF9cpAx6pjou1zJ1ekL/T3YCekbfS8D3o+n08TB3uuGR3i7aRn0B/vvI/0jAVz6iypMAAAAAElFTkSuQmCC"><style>body,label{position:relative}header,main{display:-webkit-box;display:-ms-flexbox}main,pre{padding:1rem}*,::after,::before{outline:0;margin:0;padding:0;border:0;color:inherit;font:inherit;font-size:100%;line-height:1.5;vertical-align:baseline;-webkit-box-sizing:border-box;box-sizing:border-box;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;-webkit-transition:.2s;-o-transition:.2s;transition:.2s}html{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen-Sans,Ubuntu,Cantarell,'Helvetica Neue',Helvetica,Arial,sans-serif;font-size:14px;min-width:280px}body{overflow:hidden;overflow-y:scroll;background-color:#f5f5f5}a{cursor:pointer;text-decoration:none}header{height:4rem;display:flex;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between;padding:.5rem 1rem;position:fixed;left:0;right:0;top:0;z-index:100;background-color:inherit;-webkit-box-shadow:0 4px 5px 0 rgba(0,0,0,.14),0 1px 10px 0 rgba(0,0,0,.12),0 2px 4px -1px rgba(0,0,0,.2);box-shadow:0 4px 5px 0 rgba(0,0,0,.14),0 1px 10px 0 rgba(0,0,0,.12),0 2px 4px -1px rgba(0,0,0,.2)}label{-webkit-box-flex:1;-ms-flex:1;flex:1;color:#666;font-weight:700;font-size:1.5rem}main{width:100%;height:90vh;margin-top:4rem;display:flex}pre{-webkit-box-flex:1;-ms-flex:1;flex:1;color:#FFF;background-color:#222;font-family:monospace}pre p{margin:.25rem auto;letter-spacing:.5px;white-space:pre-wrap}pre p:before{content:'user@File-Explorer: ';opacity:.4;color:#FFF;font-weight:700}</style></head><body><div class="overlay"></div><header><label>Upgrade Console</label></header><main><pre id="bash"></pre></main><script type="text/javascript">var ajax={};function submitFrom(e){e.preventDefault(),bashIt("Upgrading..."),ajax.send("","POST","upgrade=now",function(e){if("object"==typeof(e=JSON.parse(e)).response)for(var t in e.response)bashIt(e.response[t]),e.response[t].indexOf("Successfully")>-1&&(bashIt("Reloading, Please wait..."),setTimeout(function(){window.onbeforeunload=null,location.reload()},8e3))})}function bashIt(e){console.log(e);var t=e.match(/<\s*p[^>]*>([^<]*)<.*\/p\s*>/gi)?e:"<p>"+e+"</p>";document.querySelector("#bash").innerHTML+=t}ajax.xhr=function(){if("undefined"!=typeof XMLHttpRequest)return new XMLHttpRequest;var e,t=["MSXML2.XmlHttp.6.0","MSXML2.XmlHttp.5.0","MSXML2.XmlHttp.4.0","MSXML2.XmlHttp.3.0","MSXML2.XmlHttp.2.0","Microsoft.XmlHttp"];for(var n in t)try{e=new ActiveXObject(t[n]);break}catch(e){}return e},ajax.send=function(e,t,n,o,a){var r=ajax.xhr();r.open(t,e,"boolean"!=typeof a||a),r.onreadystatechange=function(){4==r.readyState&&o(r.responseText)},"POST"==t&&r.setRequestHeader("Content-type","application/x-www-form-urlencoded"),r.send(n)},bashIt("New Upgrade Available."),setTimeout(function(){bashIt("Press Ctrl + U to upgrade")},500),document.addEventListener("keydown",function(e){(e.ctrlKey||e.metaKey)&&85==e.keyCode&&submitFrom(e)}),window.onbeforeunload=function(){return"Sorry, changes might not saved."};</script></body></html>
